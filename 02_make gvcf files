#210315 R. Gourlie
#This file shows steps used to generate variant call files for an isolate
#Run in dir where reference is located
#conda activate gatk
# $1 = isolate name
# $2 = samplenumber ; increase by 1 as you add new isolates
# $3 = reference name
# $4 = reference fasta

#Map raw illumina reads of isolate to the reference; check path to fastq files before running
bowtie2 -x $3 -1 /isilon/lethbridge-rdc/users/gourlier/_raw/renamed/$1_R1.fq -2 /isilon/lethbridge-rdc/users/gourlier/_raw/renamed/$1_R2.fq -S 01_$1.sam

#Convert sam file to bam
samtools view -S -b 01_$1.sam > 02_$1.bam

#Sort bam, things such as calling variants alignments must be sorted such that the alignments occur in “genome order”. That is, ordered positionally based upon their alignment coordinates on each chromosome.
samtools sort 02_$1.bam -o 03_$1.sorted.bam

#Mark and remove duplicates from aligned BAM (duplicate reads can artificially inflate the confidence of some SNP calls)
picard MarkDuplicates --REMOVE_DUPLICATES -I 03_$1.sorted.bam -O 04_$1_removed_duplicates.bam -M 04_$1_marked_dup_metrics.txt

#Rename read groups (GATK sometimes wants the bam files to have extra metadata like which library the data comes from)
picard AddOrReplaceReadGroups -I 04_$1_removed_duplicates.bam -O 05_$1_readsgrouped.bam -RGID 4 -RGLB lib1 -RGPL illumina -RGPU unit1 -RGSM $2
samtools index 05_$1_readsgrouped.bam

#Use HaplotypeCaller to genereate VariantCallFile for isolate
gatk --java-options "-Xmx4g" HaplotypeCaller --reference $4 --sample-ploidy 1 --input 05_$1_readsgrouped.bam --output $1.g.vcf.gz --emit-ref-confidence GVCF

#organize
mkdir $1
mkdir gvcf
cp $1.g.vcf.gz gvcf/
mv $1.g.vcf.gz $1/
mv *$1* $1/
